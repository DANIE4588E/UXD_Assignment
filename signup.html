<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

    <link href="css/styles.css" rel="stylesheet" />
    <link href="css/about.css" rel="stylesheet" />
    <link href="css/header.css" rel="stylesheet" />
    <link href="css/footer.css" rel="stylesheet" />
    <link href="css/signup.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
        (function () {
            emailjs.init("7iVlo704-t1FVEKkZ");
        })();
    </script>
</head>

<body style="margin:0; display:flex; flex-direction:column; height:100vh;">
    <div id="header-placeholder" style="flex:0 0 auto; height:70px;"></div>

    <main>
        <div class="container-fluid">
            <div class="row justify-content-center align-items-center px-3 fade-in-element">
                <div class="form-container">
                    <h2 class="form-title">Join Our Community!</h2>

                    <form class="join-form" id="myForm">
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-md" placeholder="Your Name" id="name"
                                required>
                        </div>

                        <div class="mb-3">
                            <input type="email" class="form-control form-control-md" placeholder="NYP Email Address"
                                id="email" required>
                        </div>

                        <div class="mb-3">
                            <input type="tel" class="form-control form-control-md" placeholder="Phone Number" id="phone"
                                required>
                        </div>

                        <div class="mb-3">
                            <select class="form-select form-select-md" id="select" required>
                                <option value="">Experience Level</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <textarea class="form-control" rows="5" id="comment"
                                placeholder="Tell us about yourself and why you want to join!" required></textarea>
                        </div>

                        <div class="d-grid">
                            <button class="btn btn-submit btn-lg" type="submit" id="submitapp">
                                Submit Application</button>
                        </div>
                    </form>

                    <div id="statusCard" class="d-none"></div>
                </div>
            </div>
        </div>

    </main>
    <div id="footer-placeholder" style="flex:0 0 auto;"></div>

    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
    <script src="js/script.js" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('myForm');
            const submitBtn = document.getElementById('submitapp');
            const statusHost = document.getElementById('statusCard');
            const originalBtnHTML = submitBtn.innerHTML;

            function mountStatus({ type, title, message, primaryText, onPrimary, name, email, phone, experience, comment }) {
                const icon =
                    type === 'success'
                        ? `
<svg class="result-icon pop-in" viewBox="0 0 120 120" fill="none">
  <circle cx="60" cy="60" r="52" stroke="#16a34a" stroke-width="8" opacity=".2"/>
  <path d="M35 62 L53 78 L86 42" stroke="#16a34a" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" class="path-draw"/>
</svg>`
                        : `
<svg class="result-icon pop-in" viewBox="0 0 120 120" fill="none">
  <circle cx="60" cy="60" r="52" stroke="#dc2626" stroke-width="8" opacity=".2"/>
  <path d="M40 40 L80 80" stroke="#dc2626" stroke-width="8" stroke-linecap="round" class="path-draw"/>
  <path d="M80 40 L40 80" stroke="#dc2626" stroke-width="8" stroke-linecap="round" class="path-draw" style="animation-delay:.15s"/>
</svg>`;

                statusHost.innerHTML = `
  <div class="result-card fade-in-element visible p-3 rounded shadow-sm text-center">
    ${icon}
    <h3 class="mb-1">${title}</h3>
    <p class="mb-3">${message}</p>
    <h5 class="mb-2">Form Details</h5>
    <ul class="list-group list-group-flush mb-3 text-start mx-auto" style="max-width: 400px;">
      <li class="list-group-item"><strong>Name:</strong> ${name}</li>
      <li class="list-group-item"><strong>Email:</strong> ${email}</li>
      <li class="list-group-item"><strong>Phone:</strong> ${phone}</li>
      <li class="list-group-item"><strong>Experience:</strong> ${experience}</li>
      <li class="list-group-item"><strong>Comment:</strong> ${comment}</li>
    </ul>
    <div class="d-flex gap-2 justify-content-center">
      <button id="primaryAction" class="btn ${type === 'success' ? 'btn-success' : 'btn-danger'}">
        ${primaryText}
      </button>
      <button id="backToForm" class="btn btn-outline-secondary">Back to form</button>
    </div>
  </div>
`;


                statusHost.classList.remove('d-none');
                form.classList.add('d-none');

                // Bind actions
                document.getElementById('primaryAction').onclick = onPrimary;
                document.getElementById('backToForm').onclick = () => {
                    statusHost.classList.add('d-none');
                    form.classList.remove('d-none');
                };
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const experience = document.getElementById('select').value;
                const comment = document.getElementById('comment').value.trim();

                const m = email.match(/^(\d{6}[a-z])@mymail\.nyp\.edu\.sg$/i);
                if (!m) {
                    mountStatus({
                        type: 'error',
                        title: 'Invalid email',
                        message: 'Please use your NYP email (e.g. 123456a@mymail.nyp.edu.sg).',
                        primaryText: 'Retry',
                        onPrimary: () => {
                            form.reset();
                            statusHost.classList.add('d-none');
                            form.classList.remove('d-none');
                            document.getElementById('name').focus();
                        },
                        name: name,
                        email: email,
                        phone: phone,
                        experience: experience,
                        comment: comment
                    });
                    return;
                }
                const studentId = m[1].toLowerCase();

                // Spinner
                submitBtn.disabled = true;
                submitBtn.innerHTML =
                    '<span class="spinner-border spinner-border-sm me-2"></span>Submitting…';

                try {
                    await db.collection("applications").doc(studentId).set({
                        name, studentId, email, phone, experience, comment,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    await emailjs.send("service_sw6tcja", "template_8a20wsq", {
                        to_name: name, to_email: email, student_id: studentId,
                        message: 'Your application was successfully submitted!'
                    });

                    // Success card
                    mountStatus({
                        type: 'success',
                        title: 'Application submitted!',
                        message: 'We’ve sent a confirmation email to your NYP inbox.',
                        primaryText: 'Submit another',
                        onPrimary: () => {
                            form.reset();
                            statusHost.classList.add('d-none');
                            form.classList.remove('d-none');
                            document.getElementById('name').focus();
                        },
                        name: name,
                        email: email,
                        phone: phone,
                        experience: experience,
                        comment: comment
                    });

                } catch (err) {
                    console.error(err);
                    // Error card
                    mountStatus({
                        type: 'error',
                        title: 'Submission failed',
                        message: 'Please check your connection and try again.',
                        primaryText: 'Try again',
                        onPrimary: async () => {
                            statusHost.classList.add('d-none');
                            form.classList.remove('d-none');
                        },
                        name: name,
                        email: email,
                        phone: phone,
                        experience: experience,
                        comment: comment
                    });
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHTML;
                }
            });
        });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>